@{
    Layout = null;
}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password :: My Car App</title>
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link href="~/Content/AuthPageStyle.css" rel="stylesheet" />
    <link rel="icon" href="~/MyCarApp.png" type="image/imge_header">
    @{ Html.EnableClientValidation(); }
</head>
<body>

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/jqueryval")


    <div id="nofication" style="background:blue; display:none;" class="notification">
        <p id="message" style="color:white;"></p>
    </div>

    <div class="main" style="position:absolute; width:100%; margin:auto;  ">

        <!-- Sing in  Form -->
        <section class="sign-in">
            <div class="container">
                <div class="signin-content">
                    <div class="signin-image">
                        <figure><img src="~/images/rent.gif" alt="sing in image" style="border-radius:10px"></figure>
                        @Html.ActionLink("Create an Account", "Register", "User")
                        <div style="color:red;">@Html.ValidationSummary()</div>
                    </div>

                    <div class="align-vertical">

                        <form class="signin-form" id="form1">
                            <h2 class="form-title">Forgot Password</h2>
                            <div class="form-group">
                                <label for="your_email"><i class="fa fa-envelope material-icons-name"></i></label>
                                <input type="email" style=" width: 400px;" id="email" name="email" placeholder="Enter your email" required />
                            </div>

                            <div class="form-group form-button">
                                <input type="submit" id="sendEmail" class="form-submit" value="Send mail" />
                            </div>
                        </form>

                        <form class="signin-form" style="margin-top:50px; display:none;" id="form2">
                            <h2 class="form-title">Forgot Password</h2>
                            <div class="form-group">
                                <label for="your_otp"><i class="fa fa-lock material-icons-name"></i></label>
                                <input type="password" id="otp" style=" width: 400px;" name="otp" placeholder="Enter OTP" required />
                            </div>

                            <div class="form-group form-button">
                                <input type="submit" class="form-submit" value="Verify" />
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

    </div>
    <div id="process" style="        position: sticky;
        display: none;
        position: absolute;
        top: 0;
        bottom: 0;
        right: 0;
        left: 0;
        background-color: black;
        opacity: 0.7;
        z-index: 1;
">
        <img src="~/Images/process.gif" style="opacity:0.8; padding:14% 40%;" />
    </div>
    <script>

        function call() {

            document.getElementById('nofication').style.display = 'block';
            setTimeout(function () {
                $('#nofication').fadeOut('fast');
            }, 4000);
        }

        var otp = null;

        var x = $('#form1').submit(function (e) {

            e.preventDefault();

            $.ajax(
                {
                    type: "POST",
                    async: true,
                    url: "/User/ForgotPassword",
                    data: {
                        Email: $("#email").val()

                    },
                    beforeSend: function () { document.getElementById('process').style.display = 'block'; },
                    complete: function () { document.getElementById('process').style.display = 'none'; },
                    success: function (data) {
                        if (data != '-1') {
                            otp = data;
                            document.getElementById('form2').style.display = 'block';
                            document.getElementById('form1').style.display = 'none';
                            $("#message").last().html('Email Sent Succesfully.');

                            call();

                        }
                        else {
                            $("#message").last().html("User doesn't exist.");

                            call();
                        }
                    }
                });

        });

        $('#form2').submit(function (e) {
            e.preventDefault();

            if ($("#otp").val() == otp) {
                $.ajax(
                    {
                        type: "POST",
                        async: true,
                        url: "/User/ConfirmOTP",
                        data: {
                            otp: $("#otp").val()
                        },
                        success: function (data) {
                            
                            if (data == 'True') {
                                
                                $.ajax(
                                    {
                                        type: "POST",
                                        async: true,
                                        url: "/User/ResetPassword",
                                        data: {
                                            email: $("#email").val()
                                        },
                                        success: function (data) {
                                            $("#message").last().html("Successfully Verified.");
                                            call();
                                            window.location = '/User/ResetPassword';
                                        }
                                    });
                            }
                            else {
                                $("#message").last().html("Wrong OTP");
                                call();
                            }
                        }
                    });
            }
            else {
                $("#message").last().html("Wrong OTP");
                call();
            }
        });




    </script>

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")

</body>
</html>